#!/bin/bash
# Alhazen Hardened Monitor
# Automated security check script

REPORT_DIR="{{ docker_dir }}"
REPORT_FILE="${REPORT_DIR}/security-audit-$(date +%Y%m%d).log"
CONTAINER_CMD="{{ 'docker' if target_type == 'macmini' else 'podman' }}"

echo "=== Alhazen Security Audit $(date) ===" > "$REPORT_FILE"

# 1. Check Container Health
echo "[*] Checking container health..." >> "$REPORT_FILE"
$CONTAINER_CMD ps --format "{% raw %}{{.Names}} {{.Status}}{% endraw %}" 2>/dev/null | while read name status; do
  echo "  $name: $status" >> "$REPORT_FILE"
done

# 2. Check TypeDB Status
echo "[*] Checking TypeDB..." >> "$REPORT_FILE"
$CONTAINER_CMD exec alhazen-typedb /opt/typedb-all-linux-x86_64/typedb console --server=localhost:1729 <<< 'exit' >> "$REPORT_FILE" 2>&1
if [ $? -eq 0 ]; then
  echo "  TypeDB: HEALTHY" >> "$REPORT_FILE"
else
  echo "  TypeDB: UNHEALTHY" >> "$REPORT_FILE"
fi

# 3. Scan Squid Logs for Denied Requests
echo "[*] Scanning proxy logs for blocked domains..." >> "$REPORT_FILE"
$CONTAINER_CMD logs alhazen-squid 2>&1 | grep "TCP_DENIED" | tail -n 20 >> "$REPORT_FILE"

# 4. Verify Firewall Status
echo "[*] Checking Firewall State..." >> "$REPORT_FILE"
{% if target_type == 'macmini' %}
sudo pfctl -sr 2>/dev/null | head -20 >> "$REPORT_FILE"
{% else %}
sudo ufw status verbose >> "$REPORT_FILE" 2>/dev/null
{% endif %}

# 5. Check disk usage
echo "[*] Disk Usage..." >> "$REPORT_FILE"
df -h {{ docker_dir }} >> "$REPORT_FILE"

# 6. Check TypeDB data size
echo "[*] TypeDB Data Size..." >> "$REPORT_FILE"
du -sh {{ docker_dir }}/typedb-data >> "$REPORT_FILE" 2>/dev/null

echo "=== Audit Complete ===" >> "$REPORT_FILE"
echo "Report saved to: $REPORT_FILE"
