---
# Debian/Ubuntu System Setup

- name: Update Apt Cache and Upgrade System
  apt:
    update_cache: true
    upgrade: dist
    cache_valid_time: 3600

- name: Install needrestart (Debian/Ubuntu)
  apt:
    name: needrestart
    state: present

- name: Check if kernel reboot is required (needrestart)
  command: needrestart -b -k
  register: needrestart_result
  changed_when: false
  failed_when: false

- name: Reboot if required (needrestart)
  reboot:
    msg: "Rebooting to apply system updates"
  when: "'HAS_NEWER_KERNEL' in needrestart_result.stdout or needrestart_result.rc == 2"

- name: Install Essential Tools (Host)
  apt:
    name:
      - git
      - vim
      - ufw
      - fail2ban
      - openssh-server
      - sudo
      - curl
      - jq
      - gnupg
      - lsb-release
      - python3-pip
      - podman
    state: present

- name: Install Podman Compose
  apt:
    name: podman-compose
    state: present

# Tailscale Installation
- name: Add Tailscale GPG Key (Ubuntu)
  shell: |
    curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/$(lsb_release -cs).noarmor.gpg | tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
  args:
    creates: /usr/share/keyrings/tailscale-archive-keyring.gpg
  when: ansible_facts['distribution'] == 'Ubuntu'

- name: Add Tailscale Repository (Ubuntu)
  shell: |
    curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/$(lsb_release -cs).tailscale-keyring.list | tee /etc/apt/sources.list.d/tailscale.list
  args:
    creates: /etc/apt/sources.list.d/tailscale.list
  when: ansible_facts['distribution'] == 'Ubuntu'

- name: Add Tailscale Repository (Debian)
  shell: |
    curl -fsSL https://pkgs.tailscale.com/stable/debian/$(lsb_release -cs).tailscale-keyring.list | tee /etc/apt/sources.list.d/tailscale.list
  args:
    creates: /etc/apt/sources.list.d/tailscale.list
  when: ansible_facts['distribution'] == 'Debian'

- name: Update Apt Cache (Tailscale)
  apt:
    update_cache: true

- name: Install Tailscale
  apt:
    name: tailscale
    state: present

# User Setup
- name: Create Alhazen User
  user:
    name: "{{ alhazen_user }}"
    comment: "Alhazen Service User"
    shell: /bin/bash
    create_home: true
    home: "{{ alhazen_home }}"
    state: present

- name: Authorize New SSH Key for Alhazen User
  authorized_key:
    user: "{{ alhazen_user }}"
    state: present
    key: "{{ deploy_public_key }}"

- name: Setup Alhazen .ssh Directory
  file:
    path: "{{ alhazen_home }}/.ssh"
    state: directory
    owner: "{{ alhazen_user }}"
    group: "{{ alhazen_user }}"
    mode: '0700'

# Rootless Podman Setup
- name: Enable Lingering for Alhazen User
  command: "loginctl enable-linger {{ alhazen_user }}"
  args:
    creates: "/var/lib/systemd/linger/{{ alhazen_user }}"

- name: Start and Enable Tailscale
  systemd:
    name: tailscaled
    state: started
    enabled: true

- name: Display Tailscale Instruction
  debug:
    msg: "Please run 'sudo tailscale up --ssh' manually to connect to your tailnet if not already connected."
