---
- name: Check for Existing Installation (Remote)
  hosts: all
  gather_facts: false
  become: true
  tasks:
    - name: Check for existing agent identity
      stat:
        path: /etc/alhazen_identity
      register: identity_file
      ignore_errors: true

    - name: Read existing identity
      slurp:
        src: /etc/alhazen_identity
      register: identity_content
      when: identity_file.stat.exists
      ignore_errors: true

    - name: Set existing_hostname fact
      set_fact:
        existing_hostname: "{{ identity_content['content'] | b64decode | trim }}"
      when: identity_file.stat.exists and identity_content.content is defined

- name: Local Setup (Key Generation & Naming)
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    wordlist_path: "eff_large_wordlist.txt"
    remote_existing_hostname: "{{ hostvars[groups['all'][0]]['existing_hostname'] | default('') }}"

  tasks:
    - name: Ensure ssh-keys directory exists
      file:
        path: "ssh-keys"
        state: directory
        mode: '0700'

    - block:
        # PATH A: Use Existing Identity
        - name: Use Existing Hostname
          set_fact:
            generated_hostname: "{{ remote_existing_hostname }}"
          when: remote_existing_hostname | length > 0

        - name: Verify Local Key Exists for Existing Host
          stat:
            path: "ssh-keys/{{ generated_hostname }}.pem"
          register: local_key_check
          when: remote_existing_hostname | length > 0

        - name: Warn if Key Missing
          debug:
            msg: "WARNING: Host has identity '{{ generated_hostname }}' but local key is missing! You might be locked out if you don't have the original key."
          when: remote_existing_hostname | length > 0 and not local_key_check.stat.exists

        # PATH B: Generate New Identity
        - name: Read EFF Wordlist
          set_fact:
            raw_wordlist: "{{ lookup('file', wordlist_path).splitlines() }}"
          when: remote_existing_hostname | length == 0

        - name: Clean Wordlist (Extract words)
          set_fact:
            clean_words: "{{ raw_wordlist | map('regex_replace', '^[0-9]+\\s+', '') | list }}"
          when: remote_existing_hostname | length == 0

        - name: Generate Random 3-Word Hostname
          set_fact:
            generated_hostname: "{{ clean_words | random }}-{{ clean_words | random }}-{{ clean_words | random }}"
          run_once: true
          when: remote_existing_hostname | length == 0

        - name: Display Hostname
          debug:
            msg: "Target Identity: {{ generated_hostname }} ({{ 'EXISTING' if remote_existing_hostname else 'NEW' }})"

        # Key Generation (Only if missing)
        - name: Generate SSH Key Pair Locally
          command: >
            ssh-keygen -t ed25519 -f "ssh-keys/{{ generated_hostname }}.pem" -C "{{ generated_hostname }}-admin" -N ""
          args:
            creates: "ssh-keys/{{ generated_hostname }}.pem"

        - name: Generate Self-Signed SSL Certificate Locally
          command: >
            openssl req -x509 -newkey rsa:4096 -sha256 -days 3650 -nodes
            -keyout "ssh-keys/{{ generated_hostname }}.key"
            -out "ssh-keys/{{ generated_hostname }}.crt"
            -subj "/CN={{ generated_hostname }}"
            -addext "subjectAltName=DNS:{{ generated_hostname }},DNS:localhost,IP:{{ groups['all'][0] }},IP:127.0.0.1"
          args:
            creates: "ssh-keys/{{ generated_hostname }}.crt"

        - name: Read Public Key
          slurp:
            src: "ssh-keys/{{ generated_hostname }}.pem.pub"
          register: public_key_content

        - name: Read SSL Certificate Content
          slurp:
            src: "ssh-keys/{{ generated_hostname }}.crt"
          register: ssl_cert_content

        - name: Read SSL Key Content
          slurp:
            src: "ssh-keys/{{ generated_hostname }}.key"
          register: ssl_key_content

        - name: Set Facts for Deployment
          set_fact:
            alhazen_public_key: "{{ public_key_content['content'] | b64decode }}"
            alhazen_ssl_cert: "{{ ssl_cert_content['content'] | b64decode }}"
            alhazen_ssl_key: "{{ ssl_key_content['content'] | b64decode }}"

      rescue:
        - name: Cleanup Key Files on Failure
          file:
            path: "{{ item }}"
            state: absent
          loop:
            - "ssh-keys/{{ generated_hostname }}.pem"
            - "ssh-keys/{{ generated_hostname }}.pem.pub"
          when: generated_hostname is defined and remote_existing_hostname | length == 0

        - name: Fail the Playbook
          fail:
            msg: "Setup failed. Cleaned up temporary key files."

- name: Alhazen Hardened Deployment (Remote)
  hosts: all
  become: true
  vars:
    # User Configuration
    alhazen_user: "alhazen"
    alhazen_home: "/home/alhazen"

    # Paths
    docker_dir: "{{ alhazen_home }}/alhazen-docker"
    repo_dir: "{{ alhazen_home }}/skillful-alhazen"

    # Pass generated variables from first play
    target_hostname: "{{ hostvars['localhost']['generated_hostname'] }}"
    deploy_public_key: "{{ hostvars['localhost']['alhazen_public_key'] }}"

    # Deployment target type (passed from deploy.sh)
    target_type: "{{ target_type | default('vps') }}"

    # LLM Configuration (Passed from deploy.sh)
    llm_provider: "{{ llm_provider | default('anthropic') }}"
    llm_model: "{{ llm_model | default('claude-sonnet-4-20250514') }}"
    llm_url: "{{ llm_url | default('') }}"
    llm_key: "{{ llm_key | default('sk-placeholder') }}"

  roles:
    - alhazen-setup

  tasks:
    - name: Persist Agent Identity
      copy:
        content: "{{ target_hostname }}"
        dest: /etc/alhazen_identity
        mode: '0644'

  post_tasks:
    - name: Final Success Message
      debug:
        msg:
          - "Alhazen Deployment Complete!"
          - "Private Key saved locally to: ssh-keys/{{ target_hostname }}.pem"
          - "Hostname: {{ target_hostname }}"
          - "Dashboard: https://{{ inventory_hostname }}:3001"
          - "Hub: https://{{ inventory_hostname }}:8080"
          - "Connect using: ssh -i ssh-keys/{{ target_hostname }}.pem {{ alhazen_user }}@{{ inventory_hostname }}"
          - "LLM Provider: {{ llm_provider }} | Model: {{ llm_model }}"
          - "Password authentication has been DISABLED."
